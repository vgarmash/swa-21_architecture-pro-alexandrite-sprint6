# Планирование: анализ, идентификация проблем и поиск решений

## 1. Анализ проблем и нежелательных ситуаций

### 1.1. Критические проблемы (P0)

**Прямой ущерб бизнесу: потеря клиентов и контрактов**
- Клиенты B2C жалуются, что не получают заказы месяцами при обещанном сроке 3 недели
- Партнеры B2B ежедневно сообщают о неполученных заказах
- Потеряно несколько крупных контрактов через месяц после открытия API
- Рост просроченных заказов пропорционален росту нагрузки

**Системный bottleneck: синхронный расчет стоимости в MES**
- Расчет занимает 2-30 минут, блокирует создание заказа
- MES обрабатывает одновременно B2C, B2B и внутренние запросы
- Нет разделения на синхронные и асинхронные операции
- При росте нагрузки API становится недоступным даже для операторов

**Проблемы с данными и статусами заказов**
- Статусы распределены между тремя системами без единого источника истины
- Нет гарантий доставки сообщений между системами через RabbitMQ
- "Потерянные" заказы - следствие разрыва связей между CRM и MES
- Операторы не видят новые заказы из-за медленного дашборда

### 1.2. Системные проблемы (P1)

**Архитектурные ограничения**
- Монолитная MES выполняет разнородные функции (расчет, API, UI)
- Единая БД для Shop API и CRM API создает скрытые зависимости
- Один инстанс каждого сервиса и БД - single point of failure
- Отсутствие горизонтального масштабирования

**Проблемы эксплуатации**
- Ручное тестирование и деплой задерживают релизы на месяцы
- Нет observability - проблемы обнаруживаются по жалобам клиентов
- Команда не имеет компетенций для быстрого исправления ситуации

**Командные ограничения**
- 1 DevOps на всю инфраструктуру
- 1 QA с ручным тестированием
- Нехватка React-разработчиков для MES
- Нет SRE/DBA специалистов

## 2. Инициативы по устранению проблем

### 2.1. Инициативы P0 (первые 2-3 месяца)

**1. Выделение сервиса расчета стоимости и внедрение асинхронной обработки**
- **Что**: Создать отдельный микросервис Calculation Service, вынести из MES CPU-intensive операции
- **Как**: Очередь задач (RabbitMQ) + воркеры, масштабируемые независимо от MES
- **Кто**: Бэкенд Java (2) + C# (1) разработчики, DevOps для инфраструктуры
- **Срок**: 4-6 недель
- **Эффект**: Разблокировка потока заказов, снижение нагрузки на MES на 60-80%

**2. Оптимизация дашборда MES для операторов**
- **Что**: Создать read-модель для быстрого доступа к новым заказам
- **Как**: CQRS-лайт, материализованные представления, оптимизация индексов
- **Кто**: Бэкенд C# (1) + React разработчик (1), DBA (новый сотрудник)
- **Срок**: 2-3 недели
- **Эффект**: Загрузка страницы < 2 сек, операторы сразу видят новые заказы

**3. Внедрение базового мониторинга и алертинга**
- **Что**: Prometheus + Grafana для метрик, централизованные логи
- **Как**: Инструментация критичных сервисов (MES, RabbitMQ, БД)
- **Кто**: DevOps (1) + бэкенд разработчики (3)
- **Срок**: 3-4 недели
- **Эффект**: Proactive обнаружение проблем, метрики для принятия решений

### 2.2. Инициативы P1 (месяцы 3-4)

**4. Создание API Gateway для B2B партнеров**
- **Что**: Выделить B2B API в отдельный контур с rate limiting и QoS
- **Как**: API Gateway (Kong/Tyk) перед MES API, отдельные очереди
- **Кто**: Бэкенд Java (2), DevOps (1)
- **Срок**: 4 недели
- **Эффект**: Защита MES от перегрузки, приоритизация B2C заказов

**5. Горизонтальное масштабирование критичных компонентов**
- **Что**: Минимум 2 инстанса MES, CRM; репликация БД
- **Как**: Переход на managed Kubernetes (Yandex Managed Kubernetes)
- **Кто**: DevOps (1), требуется дополнительный SRE/DevOps
- **Срок**: 4-6 недель
- **Эффект**: Устранение single point of failure

**6. Автоматизация критичных E2E тестов**
- **Что**: Автотесты для цепочки "заказ → расчет → производство"
- **Как**: Использовать прототипы QA инженера, покрыть 20% критичных сценариев
- **Кто**: QA (1) + помощь бэкенд разработчиков
- **Срок**: 3 недели
- **Эффект**: Ускорение релизов на 30-40%

### 2.3. Инициативы P2 (месяцы 5-6)

**7. Выделение Order Service как единого источника истины**
- **Что**: Сервис для управления статусами заказов, event sourcing
- **Как**: Outbox паттерн, гарантированная доставка событий
- **Кто**: Бэкенд Java (2) + C# (1) с привлечением нового разработчика
- **Срок**: 6-8 недель
- **Эффект**: Ликвидация "потерянных" заказов, полная трассировка

**8. Разделение БД Shop API и CRM API**
- **Что**: Устранение скрытой зависимости через общую БД
- **Как**: Асинхронная интеграция через события, отдельные схемы/БД
- **Кто**: Бэкенд Java (2), DBA
- **Срок**: 4 недели
- **Эффект**: Независимое развитие сервисов

## 3. Расстановка приоритетов и ход рассуждений

### Критерии приоритизации:
1. **Прямое влияние на бизнес** - остановка потери клиентов
2. **Устранение системных bottlenecks** - расчет стоимости, дашборд
3. **Быстрота реализации** - эффект в 1-2 спринта
4. **Необходимые компетенции** - доступность в текущей команде

### Порядок выполнения инициатив:

**Этап 1 (Экстренный, 2 месяца):** Остановить "кровотечение"
1. **Выделение сервиса расчета стоимости** - устраняет главный bottleneck
2. **Оптимизация дашборда MES** - восстанавливает эффективность производства
3. **Базовый мониторинг** - дает видимость для дальнейших решений

**Этап 2 (Стабилизация, 2 месяца):** Создать устойчивость
4. **API Gateway для B2B** - защита от перегрузки
5. **Горизонтальное масштабирование** - отказоустойчивость
6. **Автоматизация тестов** - ускорение изменений

**Этап 3 (Развитие, 2 месяца):** Заложить основу для роста
7. **Order Service** - решает проблему "потерянных" заказов
8. **Разделение БД** - архитектурное улучшение

## 4. Целевая архитектура через полгода

Через 6 месяцев система будет иметь:

### Архитектурные изменения:
- **Calculation Service** как отдельный масштабируемый микросервис
- **API Gateway** с rate limiting для B2B партнеров
- **Read-модель** для дашборда операторов (CQRS)
- **Минимум 2 инстанса** каждого критичного сервиса
- **Репликация БД** с разделением чтения/записи

### Операционные улучшения:
- **Мониторинг** с алертами на критические метрики
- **Автоматизированные тесты** для 20% критичных сценариев
- **Ускоренные релизы** (2-4 недели вместо месяцев)

### Командные изменения:
- **Нанят SRE/DevOps** для поддержки растущей инфраструктуры
- **Нанят React разработчик** для MES фронтенда
- **QA начал переход** на автоматизированное тестирование
- **Появился DBA** на частичной занятости

## 5. Три приоритетные инициативы на ближайшие полгода

Если бы можно было выполнить только три инициативы:

### 1. Выделение сервиса расчета стоимости (4-6 недель)
**Почему**: Это главный bottleneck системы. Расчет на 30 минут блокирует весь поток заказов. Без этого решения остальные оптимизации будут малоэффективны.

**Кто**: Текущая команда (бэкенд Java + C#) + DevOps. Не требует найма.

**Эффект**: Снижение нагрузки на MES на 60-80%, разблокировка потока заказов.

### 2. Оптимизация дашборда MES (2-3 недели)
**Почему**: Операторы не могут эффективно работать. Их мотивация зависит от скорости доступа к новым заказам. Это напрямую влияет на скорость производства.

**Кто**: Текущий C# разработчик + React разработчик (частичная занятость). Возможно потребуется консультация DBA.

**Эффект**: Восстановление скорости производства, удовлетворенность операторов.

### 3. Базовый мониторинг и алертинг (3-4 недели)
**Почему**: Сейчас проблемы обнаруживаются по жалобам клиентов. Нет данных для принятия решений. Без мониторинга мы "слепы" и не сможем оценить эффект других изменений.

**Кто**: DevOps + бэкенд разработчики. Требует 20% времени от каждого.

**Эффект**: Proactive обнаружение проблем, метрики для обоснования дальнейших инвестиций.

**Обоснование выбора**: Эти три инициативы решают самые болезненные точки, реализуемы текущей командой за 6 месяцев и создают фундамент для дальнейших улучшений. Они останавливают отток клиентов сегодня, давая время для более глубоких архитектурных изменений.