# Выбор и настройка мониторинга в системе

## Мотивация

**Мониторинг — критически необходим для решения текущих бизнес-проблем "Александрита":**

1. **Прекращение потерь заказов** — сейчас о проблемах узнают по жалобам. Мониторинг позволит обнаруживать "зависшие" заказы автоматически, до обращения клиентов.
2. **Выявление узких мест** — долгий расчет стоимости (2-30 минут) и медленный дашборд MES напрямую влияют на выполнение заказов. Без метрик невозможно понять, где именно система "тормозит".
3. **Поддержка роста** — линейное увеличение на 100 заказов в месяц требует понимания, где система достигнет предела.
4. **Обеспечение SLA для B2B партнеров** — партнеры требуют надежности, что невозможно без мониторинга.
5. **Ускорение диагностики** — вместо часов поиска проблем по логам — минуты по готовым дашбордам.

**Согласование с архитектурными инициативами:**
Это решение полностью поддерживает план развития архитектуры:
- **Асинхронный расчет стоимости** → мониторинг очередей RabbitMQ и метрик расчета
- **Оптимизация дашборда MES** → метрики загрузки страниц, Web Vitals
- **Горизонтальное масштабирование** → метрики CPU, памяти для принятия решений о масштабировании
- **API Gateway для B2B** → rate limiting мониторинг, метрики по клиентам

## Выбор подхода к мониторингу

| Компонент | Подход | Согласование с архитектурой |
|-----------|--------|----------------------------|
| **Shop API, CRM API, MES API** | **RED** (Rate, Errors, Duration) | Поддержка API Gateway и разделения B2B/B2C трафика |
| **Базы данных** | **USE** (Utilization, Saturation, Errors) | Поддержка репликации БД и CQRS |
| **RabbitMQ** | **USE** | Критично для асинхронного расчета стоимости и интеграций |
| **MES (расчет стоимости)** | **Четыре золотых сигнала** | Для выделенного сервиса расчета стоимости |
| **Фронтенды** | **Web Vitals + RED** | Для оптимизации дашбордов операторов |

## Ключевые метрики (фокус на архитектурных изменениях)

### 1. RabbitMQ (критично для асинхронной архитектуры)
- **Dead-letter сообщения** → индикатор потерь заказов в очередях
- **Сообщения in-flight** → backlog для расчета стоимости
- **Ярлыки:** `queue_name`, `message_type`, `priority` (b2c/b2b)

### 2. MES API и расчет стоимости
- **Длительность расчета** (p95, p99) → основной bottleneck системы
- **CPU/Memory утилизация** → для масштабирования воркеров
- **Очередь расчетов** → индикатор перегрузки
- **Ярлыки:** `calculation_type`, `complexity` (low/medium/high)

### 3. API Gateway (планируемый компонент)
- **RPS по клиентам** → контроль B2B нагрузки
- **Rate limit срабатывания** → защита от перегрузки
- **Ярлыки:** `client_id`, `client_type`, `api_endpoint`

### 4. Базы данных (CQRS и репликация)
- **Replication lag** → критично для read реплик
- **Slow queries** → оптимизация для дашбордов
- **Ярлыки:** `db_role` (master/read_replica), `query_type`

### 5. Бизнес-метрики (согласование статусов)
- **Время в статусах** → выявление "зависаний" в цепочке заказа
- **Конверсия заказов** → KPI всей системы
- **Ярлыки:** `status`, `source` (b2c/b2b), `channel`

## План действий

### Этап 1: Базовый мониторинг (2 недели) ✅ Согласуется с приоритетом "быстрого эффекта"
1. Развертывание Prometheus + Grafana в Yandex Cloud
2. Базовые метрики инфраструктуры (CPU, память, диски)
3. Мониторинг RabbitMQ (очереди, DLQ) — критично для текущих проблем
4. Простой дашборд для операторов MES

### Этап 2: Инструментация сервисов (3 недели) ✅ Подготовка к выделению сервисов
1. Spring Boot приложения: Micrometer + бизнес-метрики
2. C# MES API: OpenTelemetry для метрик расчета стоимости
3. Базовые алерты на критические метрики

### Этап 3: Бизнес-мониторинг (2 недели) ✅ Для SLA с B2B партнерами
1. Дашборд "заказы по статусам"
2. Метрики SLA для B2B API
3. Автоматические алерты на "потерянные" заказы

### Этап 4: Автоматизация (1 неделя) ✅ Для масштабирования
1. Автоскейлинг на основе метрик
2. Rate limiting алерты
3. Runbook для частых инцидентов

## Показатели насыщенности и реакции

| Компонент | Метрика | Порог | Реакция | Архитектурная связь |
|-----------|---------|-------|---------|---------------------|
| **Очередь расчета стоимости** | Длина очереди | >20 сообщений | Алерт, увеличение воркеров | Для асинхронного расчета |
| **MES API CPU** | Утилизация | >85% | Автоскейлинг инстансов | Для горизонтального масштабирования |
| **БД соединения** | Использование пула | >80% | Оптимизация запросов | Для репликации БД |
| **B2B API трафик** | RPS на клиента | >100% квоты | Rate limiting | Для API Gateway |
| **Заказы в статусе** | Время > 2 часа | >5 заказов | Ручное вмешательство | Для сквозной трассировки |

## Распределение по командам

**Текущая команда (8 человек):**
- **DevOps (1)**: Развертывание инфраструктуры мониторинга, алертинг
- **Бэкенд Java (2)**: Инструментация Shop/CRM API, бизнес-метрики
- **C# разработчик (1)**: Метрики MES API и расчета стоимости
- **Frontend (3)**: Web Vitals для CRM/MES интерфейсов
- **QA (1)**: Synthetic тесты и мониторинг E2E сценариев
- **Тимлид**: Координация, приоритизация метрик

**Требуется нанять для поддержки развития:**
- **SRE инженер** (срочно) — эксплуатация мониторинга, создание runbook, auto-remediation
- **React разработчик** (в течение 2 месяцев) — для оптимизации MES фронтенда

## Бюджет и сроки
- **Инфраструктура**: 15-20к руб./мес (Yandex Cloud)
- **Трудозатраты**: 120 человеко-часов на внедрение
- **Сроки**: 8 недель до полноценной работы
- **ROI**: Окупаемость за 2 месяца за счет сокращения потерь заказов

## Итог
Предлагаемый мониторинг полностью поддерживает архитектурную трансформацию "Александрита":
1. **Дает данные** для обоснования выделения сервиса расчета стоимости
2. **Контролирует** асинхронные очереди — основу новой архитектуры
3. **Подготавливает** метрики для API Gateway и rate limiting
4. **Обеспечивает** наблюдаемость для горизонтального масштабирования

**Без этого мониторинга любые архитектурные изменения будут "вслепую" — мы не сможем измерить их эффект или вовремя обнаружить проблемы.**